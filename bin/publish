#!/usr/bin/env bash

set -e

export THIS_DIR=$(cd $(dirname "${BASH_SOURCE[$((${#BASH_SOURCE[@]} - 1))]}"); pwd)

cd "${THIS_DIR}/.."

function latest-version {
    curl -qs -H 'Accept: application/vnd.pub.v2+json' https://pub.dev/api/packages/$1 | jq -r '.latest.version'
}

function publish {
    cd packages/$1
    VERSION=$(grep 'version:.*' pubspec.yaml | tr -d ' ' | cut -d ':' -f 2)
    if [ "$(latest-version $1)" == "$VERSION" ]; then
        echo "$VERSION is already published"
        return 0
    fi
    if [ -f pubspec_overrides.yaml ]; then
        mv -v pubspec_overrides.yaml _pubspec_overrides.yaml
    fi
    flutter pub publish --force
    if [ -f _pubspec_overrides.yaml ]; then
      mv -v _pubspec_overrides.yaml pubspec_overrides.yaml
    fi
    until [ "$(latest-version $1)" == "$VERSION" ]; do
        echo 'Waiting...'
        sleep 3
    done
}

(publish stateful_service)
(publish shared_preferences_stateful_service_cache)
(publish riverpod_stateful_service)
(publish riverpod_stateful_service_annotation)
(publish riverpod_stateful_service_generator)
